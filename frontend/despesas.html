<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Studio • Despesas</title>
  <link rel="stylesheet" href="/assets/css/style.css?v=4"/>
  <link rel="stylesheet" href="/assets/css/app.css?v=4"/>
  <script>(function(){try{const q=new URLSearchParams(location.search);const e=q.get('embed')==='1'||(self!==top);if(!e)return;document.head.insertAdjacentHTML('beforeend',`<style>.sidebar,.topbar,.tabsbar{display:none!important}.main{margin-left:0!important}.content{padding:24px 16px!important;min-height:100vh!important}</style>`);}catch(_){}})();</script>
</head>
<body data-brand="#B89B61" data-brand2="#E7DBBE">
  <aside class="sidebar" id="appSidebar">
    <div class="sb-top">
      <div class="logo-img" style="background-image:url('/assets/img/logo.png')"></div>
      <div class="brandname">Studio Priscila Santos</div>
      <button class="toggle" id="btnToggle">≡</button>
    </div>
    <nav class="sb-menu">
      <a class="sb-item" href="/dashboard.html"><span class="sb-ico">🏠</span><span class="sb-text">Início</span></a>
      <a class="sb-item" href="/clientes.html"><span class="sb-ico">🧍</span><span class="sb-text">Cadastro Cliente</span></a>
      <a class="sb-item" href="/produtos.html"><span class="sb-ico">📦</span><span class="sb-text">Cadastro Produtos</span></a>
      <a class="sb-item" href="/servicos.html"><span class="sb-ico">💆</span><span class="sb-text">Cadastro Serviços</span></a>
      <a class="sb-item" href="/agendamentos.html"><span class="sb-ico">📅</span><span class="sb-text">Agendamento</span></a>
      <a class="sb-item" href="/vendas.html"><span class="sb-ico">💰</span><span class="sb-text">Vendas</span></a>
      <a class="sb-item active" href="/despesas.html"><span class="sb-ico">💸</span><span class="sb-text">Despesas</span></a>
      <a class="sb-item" href="/relatorios.html"><span class="sb-ico">📈</span><span class="sb-text">Relatórios</span></a>
      <a class="sb-item" href="/index.html"><span class="sb-ico">🔓</span><span class="sb-text">Sair</span></a>
    </nav>
  </aside>

  <div class="main">
    <header class="topbar"><div class="topbar-inner"><button id="btnToggleTop" class="toggle">≡</button><div class="logo"></div><div class="title">Despesas</div></div></header>
    <div class="content">
      <div class="card">
        <h2>Lançar despesa</h2>
        <form id="despForm" class="form">
          <div class="grid-2">
            <div class="input"><label>Categoria</label>
              <select id="tipo">
                <option value="USO_CONSUMO">Uso e consumo</option>
                <option value="REVENDA">Revenda (aumenta estoque)</option>
              </select>
            </div>
            <div class="input"><label>Data</label><input id="data" type="date" required></div>

            <div class="input"><label>Fornecedor</label><input id="fornecedor"></div>
            <div class="input"><label>Documento (CNPJ/CPF)</label><input id="doc"></div>

            <div class="input"><label>E-mail</label><input id="email" type="email"></div>
            <div class="input"><label>Telefone</label><input id="fone"></div>

            <div class="input" style="grid-column:1/-1"><label>Endereço</label><input id="endereco"></div>

            <!-- revenda only -->
            <div class="input revenda-only" style="display:none"><label>Produto</label><select id="produto"></select></div>
            <div class="input revenda-only" style="display:none"><label>Quantidade</label><input id="qtd" type="number" step="1" value="1"></div>
            <div class="input revenda-only" style="display:none"><label>Preço de custo (un)</label><input id="custo" type="number" step="0.01"></div>
            <div class="input revenda-only" style="display:none"><label>Preço de venda (sugerido)</label><input id="preco" type="number" step="0.01"></div>

            <div class="input" style="grid-column:1/-1"><label>Observações</label><textarea id="obs" rows="3"></textarea></div>
          </div>
          <div class="actions"><button class="btn" type="submit">Salvar</button><div id="msg" class="note"></div></div>
        </form>
      </div>
    </div>
  </div>

  <script defer>
  const $=s=>document.querySelector(s);
  function toggleSidebar(){ $('#appSidebar')?.classList.toggle('collapsed'); }
  $('#btnToggle')?.addEventListener('click', toggleSidebar);
  $('#btnToggleTop')?.addEventListener('click', toggleSidebar);

  async function fill(sel,url){ const r=await fetch(url); let d=null; try{d=await r.json();}catch(_){}
    sel.innerHTML='<option value="">—</option>';
    (d?.items||d||[]).forEach(x=>{const o=document.createElement('option');o.value=x.id;o.textContent=x.nome; sel.appendChild(o);});
  }
  fill($('#produto'),'/api/produtos');

  function toggleRevenda(){
    const rev = $('#tipo').value==='REVENDA';
    document.querySelectorAll('.revenda-only').forEach(el=>{ el.style.display = rev ? '' : 'none'; });
  }
  $('#tipo')?.addEventListener('change', toggleRevenda); toggleRevenda();

  $('#despForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const rev = $('#tipo').value==='REVENDA';
    const body={
      tipo: $('#tipo').value,
      data: $('#data').value,
      fornecedor: $('#fornecedor').value.trim(),
      doc: $('#doc').value.trim(),
      email: $('#email').value.trim(),
      telefone: $('#fone').value.trim(),
      endereco: $('#endereco').value.trim(),
      observacoes: $('#obs').value.trim()
    };
    if(rev){
      body.produto_id = $('#produto').value;
      body.quantidade = Number($('#qtd').value||0);
      body.preco_custo = Number($('#custo').value||0);
      body.preco_venda = Number($('#preco').value||0);
    }
    const r=await fetch('/api/despesas',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    let d=null; try{d=await r.json();}catch(_){}
    const msg=$('#msg'); if(!r.ok){ msg.textContent=(d&&(d.error||d.message))||`Erro ${r.status}`; msg.className='note error'; return; }
    msg.textContent='Despesa lançada!'; msg.className='note ok'; e.target.reset(); toggleRevenda();
  });

  (function(){const q=new URLSearchParams(location.search); if(q.get('embed')==='1'||(self!==top)){document.querySelectorAll('.sb-menu a').forEach(a=>{const u=new URL(a.href,location.origin);u.searchParams.set('embed','1');a.href=u.pathname+u.search;});}})();
  </script>
</body>
</html>
