<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Studio • Cadastro de Serviços</title>
  <link rel="stylesheet" href="/assets/css/style.css?v=4"/>
  <link rel="stylesheet" href="/assets/css/app.css?v=4"/>
  <script>(function(){try{const q=new URLSearchParams(location.search);const e=q.get('embed')==='1'||(self!==top);if(!e)return;document.head.insertAdjacentHTML('beforeend',`<style>.sidebar,.topbar,.tabsbar{display:none!important}.main{margin-left:0!important}.content{padding:24px 16px!important;min-height:100vh!important}</style>`);}catch(_){}})();</script>
</head>
<body data-brand="#B89B61" data-brand2="#E7DBBE">
  <aside class="sidebar" id="appSidebar">
    <div class="sb-top">
      <div class="logo-img" style="background-image:url('/assets/img/logo.png')"></div>
      <div class="brandname">Studio Priscila Santos</div>
      <button class="toggle" id="btnToggle">≡</button>
    </div>
    <nav class="sb-menu">
      <a class="sb-item" href="/dashboard.html"><span class="sb-ico">🏠</span><span class="sb-text">Início</span></a>
      <a class="sb-item" href="/clientes.html"><span class="sb-ico">🧍</span><span class="sb-text">Cadastro Cliente</span></a>
      <a class="sb-item" href="/produtos.html"><span class="sb-ico">📦</span><span class="sb-text">Cadastro Produtos</span></a>
      <a class="sb-item active" href="/servicos.html"><span class="sb-ico">💆</span><span class="sb-text">Cadastro Serviços</span></a>
      <a class="sb-item" href="/agendamentos.html"><span class="sb-ico">📅</span><span class="sb-text">Agendamento</span></a>
      <a class="sb-item" href="/vendas.html"><span class="sb-ico">💰</span><span class="sb-text">Vendas</span></a>
      <a class="sb-item" href="/despesas.html"><span class="sb-ico">💸</span><span class="sb-text">Despesas</span></a>
      <a class="sb-item" href="/relatorios.html"><span class="sb-ico">📈</span><span class="sb-text">Relatórios</span></a>
      <a class="sb-item" href="/index.html"><span class="sb-ico">🔓</span><span class="sb-text">Sair</span></a>
    </nav>
  </aside>

  <div class="main">
    <header class="topbar">
      <div class="topbar-inner">
        <button id="btnToggleTop" class="toggle">≡</button>
        <div class="logo"></div><div class="title">Cadastro de Serviços</div>
      </div>
    </header>

    <div class="content">
      <div class="card">
        <h2>Novo serviço</h2>
        <form id="srvForm" class="form">
          <div class="grid-2">
            <div class="input"><label>Nome*</label><input id="nome" required></div>
            <div class="input">
              <label>Categoria</label>
              <div style="display:flex;gap:8px">
                <select id="categoria" style="flex:1 1 auto"></select>
                <button class="btn btn-sm" id="btnAddCat" type="button">+</button>
                <button class="btn btn-sm btn-outline" id="btnDelCat" type="button">−</button>
              </div>
            </div>
            <div class="input"><label>Preço</label><input id="preco" type="number" step="0.01"></div>
            <div class="input"><label>Duração (min)</label><input id="duracao" type="number" step="5"></div>
            <div class="input" style="grid-column:1/-1"><label>Descrição</label><textarea id="descricao" rows="3"></textarea></div>
          </div>
          <div class="actions"><button class="btn" type="submit">Salvar serviço</button><div id="msg" class="note"></div></div>
        </form>
      </div>
    </div>
  </div>

  <script defer>
  const $=s=>document.querySelector(s);
  function toggleSidebar(){ $('#appSidebar')?.classList.toggle('collapsed'); }
  $('#btnToggle')?.addEventListener('click', toggleSidebar);
  $('#btnToggleTop')?.addEventListener('click', toggleSidebar);

  async function getJSON(u){ const r=await fetch(u); try{return await r.json();}catch(_){return null;} }
  async function loadCategorias(){
    const sel=$('#categoria'); sel.innerHTML='<option value="">—</option>';
    const data=await getJSON('/api/categorias?tipo=servico'); (data?.items||[]).forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.nome;sel.appendChild(o);});
  }
  $('#btnAddCat')?.addEventListener('click', async ()=>{const nome=prompt('Nome da categoria:'); if(!nome) return; await fetch('/api/categorias',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tipo:'servico',nome})}); loadCategorias();});
  $('#btnDelCat')?.addEventListener('click', async ()=>{const id=$('#categoria').value; if(!id) return alert('Selecione uma categoria'); if(!confirm('Excluir?')) return; await fetch(`/api/categorias/${id}`,{method:'DELETE'}); loadCategorias();});

  $('#srvForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const body={ nome:$('#nome').value.trim(), categoria_id:$('#categoria').value||null, preco:$('#preco').value||null, duracao_min:$('#duracao').value||null, descricao:$('#descricao').value.trim() };
    const r=await fetch('/api/servicos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    let d=null; try{d=await r.json();}catch(_){}
    const msg=$('#msg'); if(!r.ok){ msg.textContent=(d&&(d.error||d.message))||`Erro ${r.status}`; msg.className='note error'; return; }
    msg.textContent='Serviço salvo!'; msg.className='note ok'; e.target.reset();
  });

  (function(){const q=new URLSearchParams(location.search); if(q.get('embed')==='1'||(self!==top)){document.querySelectorAll('.sb-menu a').forEach(a=>{const u=new URL(a.href,location.origin);u.searchParams.set('embed','1');a.href=u.pathname+u.search;});}})();
  loadCategorias();
  </script>
</body>
</html>
