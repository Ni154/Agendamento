<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Studio • Cadastro de Produtos</title>
  <link rel="stylesheet" href="/assets/css/style.css?v=4"/>
  <link rel="stylesheet" href="/assets/css/app.css?v=4"/>
  <script>
  (function(){try{
    const q=new URLSearchParams(location.search);
    const isEmbed=q.get('embed')==='1'||(self!==top);
    if(!isEmbed) return;
    document.head.insertAdjacentHTML('beforeend',`<style>.sidebar,.topbar,.tabsbar{display:none!important}.main{margin-left:0!important}.content{padding:24px 16px!important;min-height:100vh!important}</style>`);
  }catch(e){}})();
  </script>
</head>
<body data-brand="#B89B61" data-brand2="#E7DBBE">
  <aside class="sidebar" id="appSidebar">
    <div class="sb-top">
      <div class="logo-img" style="background-image:url('/assets/img/logo.png')"></div>
      <div class="brandname">Studio Priscila Santos</div>
      <button class="toggle" id="btnToggle">≡</button>
    </div>
    <nav class="sb-menu">
      <a class="sb-item" href="/dashboard.html"><span class="sb-ico">🏠</span><span class="sb-text">Início</span></a>
      <a class="sb-item" href="/clientes.html"><span class="sb-ico">🧍</span><span class="sb-text">Cadastro Cliente</span></a>
      <a class="sb-item active" href="/produtos.html"><span class="sb-ico">📦</span><span class="sb-text">Cadastro Produtos</span></a>
      <a class="sb-item" href="/servicos.html"><span class="sb-ico">💆</span><span class="sb-text">Cadastro Serviços</span></a>
      <a class="sb-item" href="/agendamentos.html"><span class="sb-ico">📅</span><span class="sb-text">Agendamento</span></a>
      <a class="sb-item" href="/vendas.html"><span class="sb-ico">💰</span><span class="sb-text">Vendas</span></a>
      <a class="sb-item" href="/despesas.html"><span class="sb-ico">💸</span><span class="sb-text">Despesas</span></a>
      <a class="sb-item" href="/relatorios.html"><span class="sb-ico">📈</span><span class="sb-text">Relatórios</span></a>
      <a class="sb-item" href="/index.html"><span class="sb-ico">🔓</span><span class="sb-text">Sair</span></a>
    </nav>
  </aside>

  <div class="main">
    <header class="topbar">
      <div class="topbar-inner">
        <button id="btnToggleTop" class="toggle">≡</button>
        <div class="logo"></div><div class="title">Cadastro de Produtos</div>
      </div>
    </header>

    <div class="content">
      <div class="card">
        <h2>Novo produto</h2>
        <form id="prodForm" class="form">
          <div class="grid-2">
            <div class="input"><label>Nome*</label><input id="nome" required></div>
            <div class="input"><label>SKU</label><input id="sku"></div>

            <div class="input">
              <label>Categoria</label>
              <div style="display:flex;gap:8px">
                <select id="categoria" style="flex:1 1 auto"></select>
                <button class="btn btn-sm" id="btnAddCat" type="button">+</button>
                <button class="btn btn-sm btn-outline" id="btnDelCat" type="button">−</button>
              </div>
            </div>
            <div class="input"><label>Unidade</label><input id="unidade" placeholder="un, cx, pct..."></div>

            <div class="input"><label>Preço de custo</label><input id="custo" type="number" step="0.01"></div>
            <div class="input"><label>Preço de venda</label><input id="preco" type="number" step="0.01"></div>

            <div class="input"><label>Estoque inicial</label><input id="estoque" type="number" step="1"></div>
            <div class="input" style="grid-column:1/-1"><label>Observações</label><textarea id="obs" rows="3"></textarea></div>
          </div>

          <div class="actions">
            <button class="btn" type="submit">Salvar produto</button>
            <div id="msg" class="note"></div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script defer>
  const $=s=>document.querySelector(s);
  function toggleSidebar(){ $('#appSidebar')?.classList.toggle('collapsed'); }
  $('#btnToggle')?.addEventListener('click', toggleSidebar);
  $('#btnToggleTop')?.addEventListener('click', toggleSidebar);

  async function getJSON(url){ const r=await fetch(url); try{ return await r.json(); }catch(_){ return null; } }

  // categorias (carrega e permite + / −)
  async function loadCategorias(){
    const sel = $('#categoria'); if(!sel) return;
    sel.innerHTML = `<option value="">—</option>`;
    try{
      const data = await getJSON('/api/categorias?tipo=produto');
      (data?.items||[]).forEach(c=>{
        const o=document.createElement('option'); o.value=c.id; o.textContent=c.nome; sel.appendChild(o);
      });
    }catch(_){}
  }
  $('#btnAddCat')?.addEventListener('click', async ()=>{
    const nome = prompt('Nome da nova categoria:'); if(!nome) return;
    await fetch('/api/categorias',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tipo:'produto',nome})});
    loadCategorias();
  });
  $('#btnDelCat')?.addEventListener('click', async ()=>{
    const id=$('#categoria')?.value; if(!id) return alert('Selecione uma categoria');
    if(!confirm('Excluir esta categoria?')) return;
    await fetch(`/api/categorias/${id}`,{method:'DELETE'});
    loadCategorias();
  });

  $('#prodForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const body={
      nome:$('#nome').value.trim(),
      sku:$('#sku').value.trim(),
      categoria_id:$('#categoria').value||null,
      unidade:$('#unidade').value.trim(),
      preco_custo:$('#custo').value||null,
      preco_venda:$('#preco').value||null,
      estoque_inicial:$('#estoque').value||0,
      observacoes:$('#obs').value.trim()
    };
    const msg=$('#msg'); msg.textContent='Salvando...';
    const res=await fetch('/api/produtos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    let data=null; try{data=await res.json();}catch(_){}
    if(!res.ok){ msg.textContent=(data&&(data.error||data.message))||`Erro ${res.status}`; msg.className='note error'; return; }
    msg.textContent='Produto salvo!'; msg.className='note ok'; e.target.reset();
  });

  (function(){const q=new URLSearchParams(location.search); if(q.get('embed')==='1'||(self!==top)){document.querySelectorAll('.sb-menu a').forEach(a=>{const u=new URL(a.href,location.origin);u.searchParams.set('embed','1');a.href=u.pathname+u.search;});}})();
  loadCategorias();
  </script>
</body>
</html>
